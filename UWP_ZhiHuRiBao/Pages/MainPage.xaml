<common:PageBase
    x:Class="Brook.ZhiHuRiBao.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Brook.ZhiHuRiBao.Pages"
    xmlns:ui="using:CN.Brook.UI"
    xmlns:common="using:Brook.ZhiHuRiBao.Common"
    xmlns:utils="using:Brook.ZhiHuRiBao.Utils"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    mc:Ignorable="d"
    xmlns:llm="using:LLM"
    xmlns:xp="using:XP"
    xmlns:convert="using:Brook.ZhiHuRiBao.Converters"
    xmlns:data="using:Brook.ZhiHuRiBao.Models">
    
    <Page.DataContext>
        <local:MainViewModel/>
    </Page.DataContext>
    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Elements/Story.xaml"/>
                <ResourceDictionary Source="../Elements/Comment.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <CollectionViewSource x:Name="CommentGroup" Source="{x:Bind CommentList, Mode=OneWay}" IsSourceGrouped="True" />
            <convert:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <DataTemplate x:Key="GroupHeader">
                <Border>
                    <TextBlock Margin="5" Text="{Binding title}" FontSize="14" Foreground="Gray"/>
                </Border>
            </DataTemplate>
            <common:StoryDataTemplateSelector x:Key="StoryDataTemplateSelector" ItemTemplate="{StaticResource Story}" GroupTemplate="{StaticResource GroupHeader}"/>
        </ResourceDictionary>
    </Page.Resources>
    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState >
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1000"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainView.DataContext.Mode" Value="1"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <RelativePanel Background="{ThemeResource BrushPrimary}">
            <xp:XPButton x:Name="MenuButton"
                         IconPosition="OnlyIcon"
                         Background="Transparent"
                         Foreground="White"
                         PointerOverBackground="#33000000"
                         PressedBackground="#88000000"
                         Width="48"
                         Height="48"
                         IconSize="20" >
                <xp:XPButton.Icon>
                    <FontIcon Glyph="&#xE700;" FontFamily="{ThemeResource SymbolThemeFontFamily}"/>
                </xp:XPButton.Icon>
            </xp:XPButton>
        </RelativePanel>
        <SplitView x:Name="MainView" Grid.Row="1" DisplayMode="Overlay" CompactPaneLength="80">
            <SplitView.Pane>
                <ListView x:Name="CategoryListView" SelectionMode="Single" ItemTemplate="{StaticResource Story}" IsItemClickEnabled="True" ItemClick="MainListView_ItemClick">
                </ListView>
            </SplitView.Pane>
            <RelativePanel>
                <llm:LLMListView x:Name="MainListView" 
                                 Width="400" 
                                 RelativePanel.AlignLeftWithPanel="True" 
                                 SelectionMode="Single" 
                                 ItemsSource="{x:Bind StoryList}" 
                                 IsItemClickEnabled="True" 
                                 ItemClick="MainListView_ItemClick"
                                 CanPullToRefresh="True"
                                 RefreshButtonVisibility="{x:Bind IsDesktopDevice, Converter={StaticResource BoolToVisibilityConverter}}"
                                 RefreshButtonBackground="{ThemeResource BrushPrimary}"
                                 RefreshProgressRingBrush="{ThemeResource BrushPrimaryDark}"
                                 LoadMoreProgressBarBrush="{ThemeResource BrushPrimaryDark}"
                                 Background="{ThemeResource BrushListBackground}"
                                 ItemTemplateSelector="{StaticResource StoryDataTemplateSelector}">
                    <llm:LLMListView.HeaderTemplate>
                        <DataTemplate>
                            <FlipView x:Name="ImageFlipView" Background="Transparent" ItemsSource="{Binding TopStoryList}" Height="250" Width="400" Margin="0, 0, 0, 10">
                                <FlipView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Image x:Name="MainItem_Image" Stretch="UniformToFill" VerticalAlignment="Center">
                                                <Image.Source>
                                                    <BitmapImage UriSource="{Binding image}"/>
                                                </Image.Source>
                                            </Image>
                                            <Rectangle Fill="#33000000" Tapped="TapFlipImage" Tag="{Binding id}"/>
                                            <TextBlock Margin="20" TextWrapping="Wrap" Text="{Binding title}" FontSize="20" IsHitTestVisible="False" FontWeight="SemiBold" Foreground="White" VerticalAlignment="Bottom"/>
                                        </Grid>
                                    </DataTemplate>
                                </FlipView.ItemTemplate>
                            </FlipView>
                        </DataTemplate>
                    </llm:LLMListView.HeaderTemplate>
                    <llm:LLMListView.ItemContainerStyle>
                        <Style TargetType="llm:LLMListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        </Style>
                    </llm:LLMListView.ItemContainerStyle>
                </llm:LLMListView>
                <SplitView PanePlacement="Right" DisplayMode="Inline" IsPaneOpen="True" OpenPaneLength="320" CompactPaneLength="0" 
                           RelativePanel.RightOf="MainListView" RelativePanel.AlignBottomWithPanel="True" RelativePanel.AlignTopWithPanel="True" RelativePanel.AlignRightWithPanel="True" >
                    <SplitView.Pane>
                        <ListView x:Name="CommentListView" Width="320" SelectionMode="Single" ItemsSource="{x:Bind CommentGroup.View}" ItemTemplate="{StaticResource Comment}" 
                                  IsItemClickEnabled="True" ShowsScrollingPlaceholders="True">
                            <ListView.GroupStyle>
                                <GroupStyle HeaderTemplate="{StaticResource CommentHeader}"/>
                            </ListView.GroupStyle>
                        </ListView>
                    </SplitView.Pane>
                    <Grid x:Name="MainContent" BorderBrush="{ThemeResource BrushMainSplitter}" BorderThickness="4, 0, 0, 4">
                        <WebView utils:WebViewExtend.Content="{Binding HtmlSource}"/>
                        <ProgressRing x:Name="MainContentProgressRing" Width="64" Height="64" VerticalAlignment="Center" HorizontalAlignment="Center" IsActive="{Binding IsRefreshContent}" Foreground="{ThemeResource BrushPrimaryDark}"/>
                    </Grid>
                </SplitView>
            </RelativePanel>
        </SplitView>
    </Grid>
</common:PageBase>
