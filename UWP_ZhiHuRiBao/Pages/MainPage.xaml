<common:PageBase
    x:Class="Brook.ZhiHuRiBao.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Brook.ZhiHuRiBao.Pages"
    xmlns:ui="using:CN.Brook.UI"
    xmlns:common="using:Brook.ZhiHuRiBao.Common"
    xmlns:utils="using:Brook.ZhiHuRiBao.Utils"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    mc:Ignorable="d"
    xmlns:llm="using:LLM"
    xmlns:xp="using:XP"
    xmlns:convert="using:Brook.ZhiHuRiBao.Converters"
    xmlns:data="using:Brook.ZhiHuRiBao.Models"
    xmlns:vm="using:Brook.ZhiHuRiBao.ViewModels">
    
    <Page.DataContext>
        <vm:MainViewModel/>
    </Page.DataContext>
    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Elements/Story.xaml"/>
                <ResourceDictionary Source="../Elements/Comment.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <CollectionViewSource x:Name="CommentGroup" Source="{x:Bind VM.CommentList, Mode=OneWay}" IsSourceGrouped="True" />
            <convert:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <common:StoryDataTemplateSelector x:Key="StoryDataTemplateSelector" ImageTemplate="{StaticResource Story}" NoImageTemplate="{StaticResource StoryWithoutImage}" GroupTemplate="{StaticResource GroupHeader}"/>
            <DataTemplate x:Key="CategoryItem">
                <TextBlock Text="{Binding name}"/>
            </DataTemplate>
        </ResourceDictionary>
    </Page.Resources>
    
    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState >
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1000"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainView.DataContext.Mode" Value="1"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <RelativePanel Background="{ThemeResource BrushPrimary}">
            <xp:XPButton x:Name="MenuButton"
                         IconPosition="OnlyIcon"
                         Background="Transparent"
                         Foreground="White"
                         PointerOverBackground="#33000000"
                         PressedBackground="#88000000"
                         Width="48"
                         Height="48"
                         IconSize="20"
                         Click="MenuButton_Click">
                <xp:XPButton.Icon>
                    <FontIcon Glyph="&#xE700;" FontFamily="{ThemeResource SymbolThemeFontFamily}"/>
                </xp:XPButton.Icon>
            </xp:XPButton>
        </RelativePanel>
        <SplitView x:Name="MainView" Background="{ThemeResource BrushListBackground}" Grid.Row="1" DisplayMode="Overlay" OpenPaneLength="320" PaneBackground="White">
            <SplitView.Pane>
                <RelativePanel>
                    <RelativePanel x:Name="LoginPanel" Background="{ThemeResource BrushPrimary}" Height="120" Width="320">
                        <Ellipse x:Name="UserPhoto" Width="48" Height="48" Margin="4">
                            <Ellipse.Fill>
                                <ImageBrush  Stretch="Fill"/>
                            </Ellipse.Fill>
                        </Ellipse>
                        <TextBlock x:Name="UserName" x:Uid="PleaseLogin" Foreground="White" 
                                   RelativePanel.RightOf="UserPhoto"/>
                        <xp:XPButton x:Name="FavButton" BorderThickness="0"
                                     Margin="12, 0, 0, 12"
                                     Background="Transparent"
                                     PointerOverBackground="#33000000"
                                     Foreground="White"
                                     IconPosition="Left"
                                     IconInterval="12"
                                     x:Uid="Favorite"
                                     Content=""
                                     RelativePanel.AlignBottomWithPanel="True">
                            <xp:XPButton.Icon>
                                <FontIcon Glyph="&#xf005;" FontFamily="/Assets/Fonts/fontawesome-webfont.ttf#FontAwesome"/>
                            </xp:XPButton.Icon>
                        </xp:XPButton>
                        <xp:XPButton x:Name="DownloadButton" BorderThickness="0"
                                     Margin="0, 0, 12, 12"
                                     Background="Transparent"
                                     PointerOverBackground="#33000000"
                                     Foreground="White"
                                     IconPosition="Left"
                                     IconInterval="12"
                                     x:Uid="DownloadOffline"
                                     Content=""
                                     RelativePanel.AlignBottomWithPanel="True"
                                     RelativePanel.AlignRightWithPanel="True">
                            <xp:XPButton.Icon>
                                <FontIcon Glyph="&#xf019;" FontFamily="/Assets/Fonts/fontawesome-webfont.ttf#FontAwesome"/>
                            </xp:XPButton.Icon>
                        </xp:XPButton>
                    </RelativePanel>
                    <ListView x:Name="CategoryListView" 
                          SelectionMode="Single" 
                          Margin="0, 12, 0, 0"
                          Width="300"
                          ItemTemplate="{StaticResource CategoryItem}" 
                          IsItemClickEnabled="True" 
                          ItemsSource="{x:Bind VM.CategoryList}"
                          ItemClick="CategoryListView_ItemClick"
                          RelativePanel.Below="LoginPanel">
                    </ListView>
                </RelativePanel>
            </SplitView.Pane>
            <RelativePanel>
                <llm:LLMListView x:Name="MainListView" 
                                 Width="400" 
                                 RelativePanel.AlignLeftWithPanel="True" 
                                 SelectionMode="Single" 
                                 ItemsSource="{x:Bind VM.StoryDataList}" 
                                 IsItemClickEnabled="True" 
                                 ItemClick="MainListView_ItemClick"
                                 CanPullToRefresh="True"
                                 RefreshButtonVisibility="{x:Bind IsDesktopDevice, Converter={StaticResource BoolToVisibilityConverter}}"
                                 RefreshButtonBackground="{ThemeResource BrushPrimary}"
                                 RefreshProgressRingBrush="{ThemeResource BrushPrimaryDark}"
                                 LoadMoreProgressBarBrush="{ThemeResource BrushPrimaryDark}"
                                 ItemTemplateSelector="{StaticResource StoryDataTemplateSelector}">
                    <llm:LLMListView.HeaderTemplate>
                        <DataTemplate x:DataType="vm:MainViewModel">
                            <FlipView x:Name="ImageFlipView" ItemsSource="{x:Bind TopStoryList, Mode=OneWay}" Height="250" Width="400" Margin="0, 0, 0, 10">
                                <FlipView.ItemTemplate>
                                    <DataTemplate x:DataType="data:TopStory">
                                        <Grid>
                                            <Image x:Name="MainItem_Image" Stretch="UniformToFill" VerticalAlignment="Center">
                                                <Image.Source>
                                                    <BitmapImage UriSource="{x:Bind image}"/>
                                                </Image.Source>
                                            </Image>
                                            <Rectangle Fill="#33000000" Tapped="TapFlipImage" Tag="{x:Bind id}"/>
                                            <TextBlock Margin="20" TextWrapping="Wrap" Text="{x:Bind title}" FontSize="20" IsHitTestVisible="False" FontWeight="SemiBold" Foreground="White" VerticalAlignment="Bottom"/>
                                        </Grid>
                                    </DataTemplate>
                                </FlipView.ItemTemplate>
                            </FlipView>
                        </DataTemplate>
                    </llm:LLMListView.HeaderTemplate>
                    <llm:LLMListView.ItemContainerStyle>
                        <Style TargetType="llm:LLMListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        </Style>
                    </llm:LLMListView.ItemContainerStyle>
                </llm:LLMListView>
                <SplitView PanePlacement="Right" DisplayMode="Inline" IsPaneOpen="True" OpenPaneLength="320" CompactPaneLength="0" PaneBackground="Transparent"
                           RelativePanel.RightOf="MainListView" RelativePanel.AlignBottomWithPanel="True" RelativePanel.AlignTopWithPanel="True" RelativePanel.AlignRightWithPanel="True" >
                    <SplitView.Pane>
                        <llm:LLMListView x:Name="CommentListView" 
                                         Width="320" 
                                         SelectionMode="Single"
                                         ItemsSource="{x:Bind CommentGroup.View}" 
                                         ItemTemplate="{StaticResource Comment}" 
                                         IsItemClickEnabled="True" ShowsScrollingPlaceholders="True"
                                         RefreshProgressRingBrush="{ThemeResource BrushPrimaryDark}"
                                         LoadMoreProgressBarBrush="{ThemeResource BrushPrimaryDark}">   
                            <llm:LLMListView.GroupStyle>
                                <GroupStyle HeaderTemplate="{StaticResource CommentHeader}"/>
                            </llm:LLMListView.GroupStyle>
                            <llm:LLMListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </llm:LLMListView.ItemContainerStyle>
                        </llm:LLMListView>
                    </SplitView.Pane>
                    <Frame x:Name="MainContentFrame" />
                </SplitView>
            </RelativePanel>
        </SplitView>
    </Grid>
</common:PageBase>
